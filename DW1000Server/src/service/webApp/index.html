<!DOCTYPE html>
<html>
<head>
    <title></title>
	<script>
        var ratioCoordinateToPx = 100;

        var anchorColor = "#00A308";
        var tagColor = "#FF1C0A";
		var scene;
        var listTagPositions;
        
        function load()
        {
            requestScene("test");
            setInterval(requestTagPositions, 500);
        }

        function getPxFromCoordinate(coordinate)
        {
            return coordinate * ratioCoordinateToPx;
        }

        function requestScene(sceneId)
        {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (xhttp.readyState == 4 && xhttp.status == 200) {
                    scene = JSON.parse(xhttp.responseText);
                    createScene();
                    renderScene();
                }
            }
            xhttp.open("GET", "/scene?id=test", false);//SYNC!!!!!
            xhttp.send();
        }
        
        function requestTagPositions()
        {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (xhttp.readyState == 4 && xhttp.status == 200) {
                	if(xhttp.responseText != "not enough anchors for trilaterating")
               		{
                		listTagPositions = JSON.parse(xhttp.responseText);
               		}
                	renderScene();
                }
            }
            xhttp.open("GET", "/tag?a=listAllPositions", true);
            xhttp.send();
        }

        function createScene()
        {
            //create the canvas
            var width = getPxFromCoordinate(scene.endX);
            var height = getPxFromCoordinate(scene.endY);
            var html = "<canvas id='canvas' width='" + width + "' height='" + height + "' style='border: 1px black solid;'></canvas>";

            document.getElementById("canvasContainer").innerHTML = html;
        }

        function renderScene()
        {
            var ctx = document.getElementById("canvas").getContext("2d");
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);//limpiar lo anterior
            
            for (var i = 0; i < scene.listAnchors.length ; i++)
            {
                renderAnchor(ctx, scene.listAnchors[i]);
            }
            
            if(listTagPositions != null)
           	{
            	document.getElementById("divInfo").innerHTML = "";
            	for (var i = 0; i < listTagPositions.length ; i++)
                {
                    renderTag(ctx, listTagPositions[i]);
                    renderInfo(listTagPositions[i]);
                }
           	}
            
        }

        function renderAnchor(ctx, anchor)
        {
            var anchorRadius = 0.1;
            drawCircle(
                ctx,
                getPxFromCoordinate(anchor.coordinates.x),
                getPxFromCoordinate(anchor.coordinates.y), 
                getPxFromCoordinate(anchorRadius),
                anchorColor
            );
        }
        
        function renderTag(ctx, tag)
        {
            var tagRadius = 0.06;
            drawCircle(
                ctx,
                getPxFromCoordinate(tag.coordinates.x),
                getPxFromCoordinate(tag.coordinates.y), 
                getPxFromCoordinate(tagRadius),
                tagColor
            );
        }

        function drawCircle(ctx, x, y, r, fillColor)
        {
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2, true);
            ctx.closePath();
            ctx.fillStyle = fillColor;
            ctx.fill();
        }

        function drawRectangle(ctx, x, y, width, height, fillColor)
        {
            ctx.fillStyle = fillColor;
            ctx.beginPath();
            ctx.rect(x, y, width, height);
            ctx.closePath();
            ctx.fill();
        }
        
        function renderInfo(tagPosition)
        {
        	var html = "<b>tagId: "+tagPosition.tag.id+"</b></br>";
        	html+="x:"+tagPosition.coordinates.x+"<br>";
        	html+="y:"+tagPosition.coordinates.y+"<br>";
        	for(var i=0;i<tagPosition.listAnchorTagDistance.length;i++)
       		{
        		html+="distance from "+tagPosition.listAnchorTagDistance[i].anchorId+":"
        			+tagPosition.listAnchorTagDistance[i].distance+" m<br>";
       		}
        	html +="<br>";
        	document.getElementById("divInfo").innerHTML += html;
        }
    </script>
</head>
<body onload="load()">
	<table>
		<tr>
			<td><div id="canvasContainer"></div></td>
			<td><div id="divInfo"></div></td>
		</tr>
	</table>
   
</body>
</html>
